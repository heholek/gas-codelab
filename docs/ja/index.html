
<!doctype html>

<html>
<head>
  <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">
  <meta name="theme-color" content="#4F7DC9">
  <meta charset="UTF-8">
  <title>Apps Script ハンズオン</title>
  <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Source+Code+Pro:400|Roboto:400,300,400italic,500,700|Roboto+Mono">
  <link rel="stylesheet" href="//fonts.googleapis.com/icon?family=Material+Icons">
  <link rel="stylesheet" href="https://storage.googleapis.com/codelab-elements/codelab-elements.css">
  <style>
    .success {
      color: #1e8e3e;
    }
    .error {
      color: red;
    }
  </style>
</head>
<body>
  <google-codelab-analytics gaid="UA-49880327-14"></google-codelab-analytics>
  <google-codelab codelab-gaid="UA-141719032-2"
                  id="ja"
                  title="Apps Script ハンズオン"
                  environment="web"
                  feedback-link="https://github.com/tanabee/gas-codelab/issues">
    
      <google-codelab-step label="概要" duration="0">
        <p>この Codelab では、 Google Apps Script を用いて Gmail のメッセージ一覧を Google Spreadsheet に抽出するアプリケーションを作成します。<br><img alt="Output" src="img/6ec36db583a97561.png"></p>
<h2 is-upgraded>対象者</h2>
<ul>
<li>Google Apps Script 初心者</li>
<li>JavaScript 経験者</li>
</ul>
<h2 is-upgraded>ユースケース</h2>
<p>この Codelab は以下のようなケースを想定しています。</p>
<ul>
<li>特定のメーリス、もしくはメールアドレスへのユーザーからの問い合わせの集計、分析</li>
<li>REST API は提供していないがメール通知機能を提供しているアプリケーションとのシステム連携</li>
</ul>


      </google-codelab-step>
    
      <google-codelab-step label="準備" duration="0">
        <p>Gmail もしくは G Suite のアカウントが必要です。もしまだアカウントがない場合には <a href="https://accounts.google.com/signup" target="_blank">Gmail アカウントを作成</a>してください。</p>
<aside class="warning"><p>Gmail アカウントを作成した場合には、以下の手順に沿ってください。</p>
</aside>
<h2 is-upgraded>1. mail-to-me アプリケーションを開く</h2>
<p><a href="https://script.google.com/d/1p2B0NwXg3APMc-nh-fRWuMX6P_W5eQijsi4CVEHLOOq7_zJmQbWyZAWl/edit?usp=sharing" target="_blank">mail-to-me</a> アプリケーションをブラウザで開く。</p>
<h2 is-upgraded>2. コピーを作成</h2>
<p><strong>File</strong> &gt; <strong>Make a Copy</strong> を選択。</p>
<h2 is-upgraded>3. mail-to-me の実行</h2>
<p><strong>Run</strong> ボタンをクリック。</p>
<h2 is-upgraded>4. Gmail を確認</h2>
<p><a href="https://mail.google.com" target="_blank">Gmail</a> をブラウザで開き、メールが受信されていることを確認する。以上で準備は完了です。</p>


      </google-codelab-step>
    
      <google-codelab-step label="プロジェクトの作成" duration="0">
        <p>Apps Script のプロジェクトを作成しましょう。まず <a href="https://drive.google.com" target="_blank">drive.google.com</a> にアクセスし、スプレッドシートファイルを作成します。</p>
<p><img alt="Create a new drive file" src="img/20cf609cb24e5367.png"><strong>New</strong> をクリック</p>
<p><img alt="Create a new Spreadsheet file" src="img/8cffacf23c92b025.png"><strong>Google Sheets</strong> を選択するとスプレッドシートファイルが作成されます。</p>
<p><img alt="Rename Spreadsheet file" src="img/cc34ba6c521b983c.png"><br>ファイル名を選択し、ファイル名（gmail-to-spreadsheet など）を入力します。</p>
<p><img alt="Select Script editor menu" src="img/788bb99d22ce17be.png"><strong>Tools</strong> &gt; <strong>Script editor</strong> メニューを選択すると Google Apps Script プロジェクトが作成されます。</p>
<p><img alt="Rename Google Apps Script project" src="img/b39d9ba12ad5e311.png"><br>プロジェクト名を選択し、プロジェクト名（gmail-to-spreadsheet など）を入力します。</p>
<p><img alt="Input Google Apps Script project name" src="img/f1c2de0caf46b50e.png"><br>プロジェクト名を入力して OK ボタンをクリックするとプロジェクトが保存されます。トーストが表示されてから、非表示になったところで保存が完了します。</p>
<p>これでスクリプトを実行できるようになりました。次のセクションでスクリプトを実行していきます。</p>


      </google-codelab-step>
    
      <google-codelab-step label="スクリプトの実行" duration="0">
        <p>下記のコードをコピーしてスクリプトエディタに貼り付けてください。その後 <strong>Run</strong> ボタンをクリックします。</p>
<pre><code>function main() {
  Logger.log(&#39;Hello Google Apps Script!&#39;);
}
</code></pre>
<p class="image-container"><img alt="Run script" src="img/d9d39332483e1626.png"></p>
<p><code>Logger.log()</code> 関数は Google Apps Script のログ出力関数です。</p>
<p><img alt="View the script logs" src="img/340da3e798aac65a.png"><strong>View</strong> &gt; <strong>Logs</strong> を選択すると出力されたログを確認できます。</p>
<p><img alt="log viewer" src="img/19ffc24655f971b.png"><code>Hello Google Apps Script!</code> と出力されているのが確認できました。</p>
<p><code>console.log()</code> 関数を使うこともできますが、<code>console.log()</code> 関数を利用するためには別の設定が必要になるため、この Codelab では <code>Logger.log()</code> 関数を利用します。</p>


      </google-codelab-step>
    
      <google-codelab-step label="GmailApp クラス" duration="0">
        <p>次に、 GmailApp クラスを見てみます。GmailApp クラスとメソッドについては<a href="https://developers.google.com/apps-script/reference/" target="_blank">公式リファレンス</a> から確認できます。<a href="https://developers.google.com/apps-script/reference/gmail/gmail-app" target="_blank">GmailApp</a> のドキュメントを見てみます。Gmail に関連するクラス (e.g. <a href="https://developers.google.com/apps-script/reference/gmail/gmail-message" target="_blank">GmailMessage</a>, <a href="https://developers.google.com/apps-script/reference/gmail/gmail-thread" target="_blank">GmailThread</a> ) やメソッド (e.g. <a href="https://developers.google.com/apps-script/reference/gmail/gmail-app#searchquery,-start,-max" target="_blank">search</a>, <a href="https://developers.google.com/apps-script/reference/gmail/gmail-app#sendemailrecipient,-subject,-body,-options" target="_blank">sendEmail</a>) が確認できます。</p>
<p class="image-container"><img alt="GmailApp reference" src="img/e0328ecf0ef098ab.png"></p>
<p>今回は <a href="https://developers.google.com/apps-script/reference/gmail/gmail-app#searchquery,-start,-max" target="_blank">Gmail.search</a> を使ってメール一覧を取得します。</p>


      </google-codelab-step>
    
      <google-codelab-step label="GmailThead の取得" duration="0">
        <p>ではスクリプトを実装していきます。<a href="https://developers.google.com/apps-script/reference/gmail/gmail-app#searchquery,-start,-max" target="_blank">Gmail.search</a> メソッドを使って Gmail のスレッド一覧を取得します。</p>
<pre><code>function main() {
  var searchText = &#39;&#39;;// You can set value.
  var threads = GmailApp.search(searchText, 0, 5);
  Logger.log(threads);
}
</code></pre>
<p>特定のメーリスなど、検索条件を設定したい場合には searchText に値を代入してください。公式サポートページに<a href="https://support.google.com/mail/answer/7190?hl=ja" target="_blank">検索演算子</a>についてまとめられています。</p>
<p><strong>Run</strong> ボタンをクリックして実行します。</p>
<p><img alt="Authorization popup" src="img/1a57d3b6918ab32b.png"><br>このスクリプトに Gmail の操作を認可するため、ポップアップが表示されます。Gmail リソースへのアクセスを認可する必要があります。 <strong>Review Permissions</strong> をクリックします。</p>
<p><img alt="Choose an account" src="img/9e8f390a572f4bee.png"><br>この Codelab で使っているアカウントを選択します。</p>
<p><img alt="Application verification" src="img/560aec6856abd7cf.png"><img alt="Application verification advanced" src="img/d2ad75b68cfc9af3.png"><br>このアプリケーションを確認するために、 <strong>Advanced</strong> を選択し <strong>Go to ...</strong> と書かれたリンクをクリックします。もし、この画面が表示されない場合には、この手順はスキップしてください。</p>
<p><img alt="Allow authentication" src="img/540547e167502a58.png"><br>このアプリケーションに与える必要のあるスコープが表示されます。 <strong>Allow</strong> ボタンをクリック後、スクリプトエディタに戻ってスクリプトが実行されます。</p>
<p><img alt="Allow authentication" src="img/5be1979211c8f557.png"><br>ログを見てみましょう。GmailThread の配列が出力されています。たった 5 行のコードでメールの一覧を取得して出力することができました！この認可のポップアップのフローのために、通常実装するのが大変な認証周りのコードを書く必要がなくなるため、非常に簡単にアプリケーション連携ができるのです。</p>


      </google-codelab-step>
    
      <google-codelab-step label="GmailMessage のパース" duration="0">
        <p>直前のセクションで Gmail のスレッド一覧を取得できました。今回はメッセージの件名、本文、送信元、送信先、日時を取得します。そのため、GmailThread からそれに紐づくメッセージを取得します。</p>
<p><img alt="GmailThread.getMessages reference" src="img/a0af6ab48051acaa.png"><br>Apps Script のリファレンスを見てみましょう。 GmailThread クラスには <a href="https://developers.google.com/apps-script/reference/gmail/gmail-thread#getmessages" target="_blank">getMessages()</a> メソッドが用意されており GmailMessage の配列を返します。 <strong>GmailMessage</strong> のリンクをクリックしてそのメソッドを確認しましょう。</p>
<p><img alt="GmailMessage reference" src="img/a636968464c90ec8.png"><br>GmailMessage クラスには getSubject, getBody, getFrom, getTo, getDate など多数の取得系メソッドが用意されています。 <code>GmailThread.getMessages()</code> を用いて求める値が取得できそうです。</p>
<p>今回はスレッド内の最初のメッセージを使います。メッセージを取得してログを見てみましょう。</p>
<pre><code>function main() {
  var searchText = &#39;&#39;;
  var threads = GmailApp.search(searchText, 0, 5);
  threads.forEach(function (thread) {
    var message = thread.getMessages()[0];
    Logger.log(message);
  });
}
</code></pre>
<p><img alt="GmailMessage log" src="img/74d764298536638b.png"><strong>GmailMessage</strong> というテキストが表示されます。</p>
<p>最後に、取得系のメソッドを叩いて値を取得します。</p>
<pre><code>function main() {
  var searchText = &#39;&#39;;
  var threads = GmailApp.search(searchText, 0, 5);
  threads.forEach(function (thread) {
    var message = thread.getMessages()[0];
    Logger.log(message.getSubject());
    Logger.log(message.getFrom());
    Logger.log(message.getTo());
    Logger.log(message.getPlainBody());
    Logger.log(message.getDate());
  });
}
</code></pre>
<p><img alt="Get Gmail message values" src="img/a3500ea8c3d3d9aa.png"><br>スクリプトを実行してログを見てみます。Gmail メッセージの値を取得できました。次のセッションからは、これらの値を Spreadsheet に保存していきます。</p>


      </google-codelab-step>
    
      <google-codelab-step label="SpreadsheetApp クラス" duration="0">
        <p>// TODO: Graph: Spreadsheet &gt; Sheet &gt; Range</p>
<p>次に、 SpreadsheetApp クラスについて理解します。<a href="https://developers.google.com/apps-script/reference/spreadsheet/spreadsheet-app" target="_blank">SpreadsheetApp reference</a> にアクセスし、<a href="https://developers.google.com/apps-script/reference/spreadsheet/spreadsheet-app#getactivesheet" target="_blank">getActiveSheet</a> のセクションを確認します。このメソッドを使うことで作成したスプレッドシートにアクセスすることができます。</p>
<p>下記のメソッドを実行します。Gmail の時と同様に認証の許可が必要です。</p>
<pre><code>function saveMessages() {
  Logger.log(SpreadsheetApp.getActiveSheet().getName());
}
</code></pre>
<p><img alt="Logging Spreadsheet tab name" src="img/e795ba69053654fc.png"><img alt="Spreadsheet tab name" src="img/cefdc34f0f07c135.png"><br>ログビュアーでスプレッドシートのタブ名が表示されます。 Spreadsheet にデータを保存するためには <a href="https://developers.google.com/apps-script/reference/spreadsheet/range" target="_blank">Range</a> クラスにアクセスし<a href="https://developers.google.com/apps-script/reference/spreadsheet/range#setvaluesvalues" target="_blank">Range.setValues()</a> を叩く必要があります。</p>
<pre><code>function saveMessages() {
  var data = [
    [&#39;a&#39;, &#39;b&#39;, &#39;c&#39;],
    [&#39;d&#39;, &#39;e&#39;, &#39;f&#39;],
  ];
  SpreadsheetApp
    .getActiveSheet()
    .getRange(&#34;A1:C2&#34;)
    .setValues(data);
}
</code></pre>
<p><img alt="Range.setValues" src="img/d845168e2d88f825.png"><code>saveMessages</code> を実行し Spreadsheet を見てみると値が挿入されていることが確認できます。ここで引数に指定したデータが 2 次元配列であることに注意してください。</p>
<p>ここで、データを引数で渡せるように関数を編集します。今回は 5 つのタイプの値を保存するため、列 &#34;E&#34; は固定とします。</p>
<pre><code>function saveMessages(data) {
  SpreadsheetApp
    .getActiveSheet()
    .getRange(&#34;A1:E&#34; + data.length)
    .setValues(data);
}
</code></pre>
<p>外から叩くためのテストとして、 <code>test</code> 関数を実装し、実行してみます。</p>
<pre><code>function test() {
  var data = [
    [&#39;a&#39;, &#39;b&#39;, &#39;c&#39;, &#39;d&#39;, &#39;e&#39;],
    [&#39;f&#39;, &#39;g&#39;, &#39;h&#39;, &#39;i&#39;, &#39;j&#39;],
    [&#39;A&#39;, &#39;B&#39;, &#39;C&#39;, &#39;D&#39;, &#39;E&#39;],
    [&#39;F&#39;, &#39;G&#39;, &#39;H&#39;, &#39;I&#39;, &#39;J&#39;],
  ];
  saveMessages(data);
}
</code></pre>
<p><img alt="set data as argument" src="img/398f7f8a7668eb9a.png"><br>無事に <code>saveMessages</code> 関数を叩けて Spreadsheet に値が挿入されました。テストできたので test 関数を削除します。次のセクションでは <code>main</code> 関数から <code>saveMessages</code> 関数を叩いて Gmail のメッセージ一覧を保存します。</p>


      </google-codelab-step>
    
      <google-codelab-step label="メッセージを Spreadsheet に保存" duration="0">
        <p><code>saveMessages</code> 関数を叩けるように <code>main</code> 関数を更新します。 <code>messages</code> の値を 2 次元配列になるようにします。</p>
<pre><code>function main() {
  var searchText = &#39;&#39;;
  var threads = GmailApp.search(searchText, 0, 5);
  var messages = [];
  threads.forEach(function (thread) {
    var message = thread.getMessages()[0];
    // single cell characters limit
    if (message.getPlainBody().length &gt; 50000) {
      return;
    }
    messages.push([
      message.getSubject(),
      message.getFrom(),
      message.getTo(),
      message.getPlainBody(),
      message.getDate(),
    ]);
  });
  saveMessages(messages);
}

function saveMessages(data) {
  SpreadsheetApp
    .getActiveSheet()
    .getRange(&#34;A1:E&#34; + data.length)
    .setValues(data);
}
</code></pre>
<p><code>main</code> 関数を実行し、Spreadsheet を確認します。</p>
<p class="image-container"><img alt="save gmail messages to Spreadsheet" src="img/9cfdb1ebbc26bba5.png"></p>
<p>Spreadsheet で Gmail メッセージのデータを確認できました。それぞれの列が何を示すのか理解しやすくするために、最初の列に列名を指定します。コードの 4 行目で messages を定義している行を以下に書き換えて実行します。</p>
<pre><code>  var messages = [[&#39;Subject&#39;, &#39;From&#39;, &#39;To&#39;, &#39;Body&#39;, &#39;Date&#39;]];
</code></pre>
<p class="image-container"><img alt="add column names" src="img/a3981b72cd4c5644.png"></p>
<p>列の意味がわかりやすくなりました。30 行に満たないコードで Gmail と Spreadsheet を連携するアプリケーションを作成することができました！</p>


      </google-codelab-step>
    
      <google-codelab-step label="Spreadsheet のカスタムメニュー" duration="0">
        <p>これまで作ったアプリケーションで十分要件を満たしますが、これをもっと使いやすくすることができます。 Spreadsheet にカスタムメニューを追加し、それを選択することで Gmail からメッセージ一覧を取得できるようにします。下記の <code>onOpen</code> 関数を追加し実行します。 <code>onOpen</code> という関数名は予約されており、Spreadsheet が開かれるタイミングで呼ばれます。詳しくは <a href="https://developers.google.com/apps-script/guides/triggers#onopene" target="_blank">公式ドキュメント</a> で確認できます。</p>
<pre><code>function onOpen() {
  SpreadsheetApp
    .getActiveSpreadsheet()
    .addMenu(&#39;Gmail&#39;, [
      {name: &#39;Fetch&#39;, functionName: &#39;main&#39;},
    ]);
}
</code></pre>
<p class="image-container"><img alt="Spreadsheet custom menu" src="img/fbab786db5ca97e2.png"></p>
<p>Spreadsheet を見てみましょう。カスタムメニューが表示されます。 <strong>Gmail</strong> &gt; <strong>Fetch</strong> を選択します。</p>
<p>Spreadsheet の値をリセットできるとなおよいでしょう。 <code>clearSheet</code> 関数を追加してメニューに追加します。</p>
<pre><code>function onOpen() {
  SpreadsheetApp
    .getActiveSpreadsheet()
    .addMenu(&#39;Gmail&#39;, [
      {name: &#39;Fetch&#39;, functionName: &#39;main&#39;},
      {name: &#39;Clear sheet&#39;, functionName: &#39;clearSheet&#39;},
    ]);
}

function clearSheet() {
  SpreadsheetApp
    .getActiveSheet()
    .clear();
}
</code></pre>
<p><strong>Clear sheet</strong> サブメニューが追加されるので実行してみましょう。</p>


      </google-codelab-step>
    
      <google-codelab-step label="自動化" duration="0">
        <p><a href="https://developers.google.com/apps-script/guides/triggers/installable" target="_blank">Trigger</a> を使って自動化の設定をすることも可能です。 <a href="https://developers.google.com/apps-script/guides/triggers/installable#time-driven_triggers" target="_blank">Time-driven trigger</a> を設定して <code>main</code> 関数を 1 分おきに実行してみましょう。</p>
<p>以下に沿って進めます。</p>
<p><img alt="Current project’s triggers" src="img/c28e85e048b97d46.png"><strong>Edit</strong> &gt; <strong>Current project&#39;s trigger</strong> を選択します</p>
<p><img alt="Add triggers" src="img/488d87649109eafc.png"><strong>Add Trigger</strong> を選択します</p>
<p><img alt="Trigger settings" src="img/f31c6fb6f3893336.png"><br>ポップアップが表示されるので Trigger の設定を行います。上の画像の通り設定して <strong>Save</strong> ボタンを選択します。</p>
<p><img alt="Trigger is created" src="img/b09bb924d0f862f9.png"><br>トリガーが作成されました！ドットアイコンを選択します。</p>
<p><img alt="Select executions menu" src="img/2af35ddff6272349.png"><strong>Executions</strong> を選択します。</p>
<p class="image-container"><img alt="Executions" src="img/df9ecee0b6fd9d5f.png"></p>
<p><code>main</code> 関数が 1 分おきに実行されているのが確認できます。新しいメッセージを受信した際でも最新の状態を保つことができます。</p>
<p><img alt="Delete trigger" src="img/ebf01e761d3f8374.png"><br>ドットアイコン &gt; <strong>Delete trigger</strong> を選択することで Trigger を削除できます。</p>
<p><img alt="Triggers" src="img/b49b0a3ad3e4f14b.png"><br>Google Apps Script には様々な種類の Trigger が用意されています。 Trigger を使うことでプロジェクトをより便利にすることができます。</p>


      </google-codelab-step>
    
      <google-codelab-step label="Congrats!" duration="0">
        <p>おめでとうございます！この Codelab は以上で終了です。最終的なコードは以下で確認できます。また <a href="https://github.com/tanabee/gas-codelab" target="_blank">tanabee/gas-codelab</a> の GitHub にも上がっています。</p>
<pre><code>function onOpen() {
  SpreadsheetApp
    .getActiveSpreadsheet()
    .addMenu(&#39;Gmail&#39;, [
      {name: &#39;Fetch&#39;, functionName: &#39;main&#39;},
      {name: &#39;Clear sheet&#39;, functionName: &#39;clearSheet&#39;},
    ]);
}

function main() {
  var searchText = &#39;&#39;;
  var threads = GmailApp.search(searchText, 0, 500);
  var messages = [[&#39;Subject&#39;, &#39;From&#39;, &#39;To&#39;, &#39;Body&#39;, &#39;Date&#39;]];
  threads.forEach(function (thread) {
    var message = thread.getMessages()[0];
    // single cell characters limit
    if (message.getPlainBody().length &gt; 50000) {
      return;
    }
    messages.push([
      message.getSubject(),
      message.getFrom(),
      message.getTo(),
      message.getPlainBody(),
      message.getDate(),
    ]);
  });
  saveMessages(messages);
}

function saveMessages(data) {
  clearSheet();
  SpreadsheetApp
    .getActiveSheet()
    .getRange(&#34;A1:E&#34; + data.length)
    .setValues(data);
}

function clearSheet() {
  SpreadsheetApp
    .getActiveSheet()
    .clear();
}
</code></pre>
<h2 is-upgraded>Next Action</h2>
<p>このプロジェクトをより便利にするアイデアを載せておきます。</p>
<ul>
<li>500 件以上の Gmail メッセージの取得 (for 文を使って)</li>
<li>Spreadsheet への保存を上書きでなく追加する形式にする</li>
<li>フォームの送信結果など固定フォーマットの本文を解析して保存する</li>
<li><a href="https://datastudio.google.com" target="_blank">Data Studio</a> を使った見える化</li>
</ul>


      </google-codelab-step>
    
  </google-codelab>

  <script src="https://storage.googleapis.com/codelab-elements/native-shim.js"></script>
  <script src="https://storage.googleapis.com/codelab-elements/custom-elements.min.js"></script>
  <script src="https://storage.googleapis.com/codelab-elements/prettify.js"></script>
  <script src="https://storage.googleapis.com/codelab-elements/codelab-elements.js"></script>

</body>
</html>
